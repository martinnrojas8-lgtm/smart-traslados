<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Smart Traslados - Ingreso</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00c853">

<style>
  body { margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; overflow:hidden; }
  .logo { width: 120px; margin-bottom: 20px; }
  .login-card { background:#111; padding:30px; border-radius:15px; border:1px solid #333; width:85%; max-width:350px; text-align:center; }
  input, select { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; background:#222; color:#fff; box-sizing:border-box; }
  button { width:100%; padding:15px; margin-top:20px; border-radius:8px; border:none; background:#00c853; color:#000; font-weight:bold; cursor:pointer; font-size:16px; }
  .footer-link { margin-top:20px; font-size:13px; color:#888; cursor:pointer; text-decoration:underline; }
  
  /* Banner de InstalaciÃ³n */
  #installBanner { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #00c853; color: #000; padding: 15px; text-align: center; font-weight: bold; z-index: 999; cursor: pointer; }
</style>
</head>
<body>

<img src="/file_000000008fd0720eb71af76359ccb359.png" class="logo" alt="Logo">

<div class="login-card" id="cardLogin">
  <h2 style="margin-top:0;">Bienvenido</h2>
  <p style="font-size:14px; color:#aaa;">IngresÃ¡ tu nÃºmero para comenzar</p>
  
  <input type="tel" id="telefono" placeholder="NÃºmero de telÃ©fono">
  <select id="rol">
    <option value="pasajero">Soy Pasajero</option>
    <option value="chofer">Soy Chofer</option>
  </select>
  
  <button onclick="entrar()">INGRESAR</button>
  <div class="footer-link" onclick="cambiarModo()">Â¿No tenÃ©s cuenta? Registrate</div>
</div>

<div id="installBanner" onclick="instalarApp()">
  ðŸš€ DESCARGAR SMART TRASLADOS APP
</div>

<script>
let modoRegistro = false;
let deferredPrompt;

// 1. REGISTRO DE SERVICE WORKER PARA PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
}

// 2. DETECTAR SI LA APP SE PUEDE INSTALAR
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBanner').style.display = 'block';
});

function instalarApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                document.getElementById('installBanner').style.display = 'none';
            }
        });
    }
}

// 3. LÃ“GICA DE LOGIN / REGISTRO
function cambiarModo() {
    modoRegistro = !modoRegistro;
    const btn = document.querySelector("button");
    const link = document.querySelector(".footer-link");
    const titulo = document.querySelector("h2");
    
    if(modoRegistro) {
        titulo.innerText = "Crear Cuenta";
        btn.innerText = "REGISTRARME";
        link.innerText = "Ya tengo cuenta, ingresar";
    } else {
        titulo.innerText = "Bienvenido";
        btn.innerText = "INGRESAR";
        link.innerText = "Â¿No tenÃ©s cuenta? Registrate";
    }
}

function entrar() {
    const tel = document.getElementById("telefono").value.trim();
    const rol = document.getElementById("rol").value;
    const ruta = modoRegistro ? "/register" : "/login";

    if(!tel) return alert("IngresÃ¡ tu telÃ©fono");

    fetch(ruta, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ telefono: tel, rol: rol })
    })
    .then(r => r.json())
    .then(data => {
        if(data.error) {
            alert(data.error);
        } else {
            // Guardamos los datos recibidos del servidor en la sesiÃ³n local
            localStorage.setItem("sesion", JSON.stringify(data));
            
            // RedirecciÃ³n segÃºn rol
            if(data.rol === "pasajero") window.location.href = "/pasajero/index.html";
            if(data.rol === "chofer") window.location.href = "/chofer/index.html";
        }
    })
    .catch(err => alert("Error de conexiÃ³n"));
}
</script>

</body>
</html>
