<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; border-bottom: 2px solid #4caf50; display: flex; align-items: center; justify-content: center; gap: 10px; }
.logo-header { height: 35px; width: auto; border-radius: 5px; }
.menu{ display:flex; overflow-x: auto; background:#1a1a1a; white-space: nowrap; border-bottom: 1px solid #333; }
.menu button{ padding:15px 20px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; flex-shrink: 0; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #333; }
input, select{ width:95%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background: #fff; color: #000; font-weight: bold; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:13px; }
.estado-ok{ color:#4caf50; font-weight: bold; }
.estado-off{ color:#f44336; font-weight: bold; }
.estado-pendiente { color: #ff9800; font-weight: bold; }
.btn-ok{ background:#4caf50; color: #fff; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
.btn-accion{ padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; margin-right: 2px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
#modalPerfil { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow-y:auto; padding:20px; }
.modal-contenido { background:#111; padding:20px; border-radius:10px; border:1px solid #4caf50; max-width:500px; margin:auto; }
.foto-legajo { width:100%; max-height: 400px; object-fit: contain; border-radius:8px; margin-bottom:15px; border:1px solid #333; background: #000; }
.ficha-codigo { font-size: 42px; font-weight: bold; color: #4caf50; letter-spacing: 5px; margin: 5px 0; }
.btn-compartir { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
.btn-compartir:active { transform: scale(0.9); }
.ignore-capture { visibility: hidden !important; }
</style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" class="logo-header" alt="logo">
    <span>Smart Traslados ‚Äì Admin</span>
</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('estadisticas')">Estad√≠sticas</button>
    <button onclick="mostrar('pagos')">Generar PIN</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="modalPerfil">
  <div class="modal-contenido">
    <h3 id="nomPerfil" style="margin-top:0; color:#4caf50;"></h3>
    <p><b>Carnet de Conducir:</b></p>
    <img id="imgCarnet" class="foto-legajo" alt="Sin cargar">
    <p><b>Seguro:</b></p>
    <img id="imgSeguro" class="foto-legajo" alt="Sin cargar">
    <p><b>Tarjeta del Auto:</b></p>
    <img id="imgTarjeta" class="foto-legajo" alt="Sin cargar">
    <button class="btn-ok" onclick="cerrarPerfil()">CERRAR PERFIL</button>
  </div>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card"><h3>Resumen operativo</h3><p>Conductores registrados: <b id="cActivos">0</b></p><p>Pasajeros registrados: <b id="pTotal">0</b></p></div>
</div>

<div id="conductores" class="pantalla">
    <div class="card"><h3>Gesti√≥n de Conductores</h3><div style="overflow-x:auto;"><table id="tablaConductores"><tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card"><h3>Lista de Pasajeros</h3><div style="overflow-x:auto;"><table id="tablaPasajeros"><tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="viajes" class="pantalla">
    <div class="card"><h3>Historial de Viajes Reales</h3><div style="overflow-x:auto;"><table id="tablaViajes"><tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Calif.</th><th>Estado</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="estadisticas" class="pantalla">
    <div class="card">
        <h3>Consultar Demanda por Fecha</h3>
        <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Seleccion√° un d√≠a del calendario para ver el detalle horario.</p>
        
        <input type="date" id="inputFechaEst" onchange="actualizarEstadisticasFecha()" style="margin-bottom: 20px;">

        <h4 id="tituloDia" style="color:#4caf50; border-bottom: 1px solid #333; padding-bottom: 5px;">Seleccione una fecha</h4>
        <div style="overflow-x:auto;">
            <table id="tablaEstadisticasHoras">
                <tr><th>Franja Horaria</th><th>Viajes Solicitados</th></tr>
            </table>
        </div>
    </div>
</div>

<div id="pagos" class="pantalla">
    <div class="card" style="text-align:center;">
        <h3>Generar Pin de Activaci√≥n 24hs</h3>
        <button class="btn-ok" onclick="generarNuevoCodigo()">GENERAR NUEVO C√ìDIGO</button>
        
        <div id="contenedorFicha" style="position: relative; display: none; flex-direction: column; align-items: center; background: #fff; padding: 25px; border-radius: 15px; max-width: 300px; margin: 25px auto; color: #000; text-align: center; border: 3px solid #4caf50; box-shadow: 0 10px 20px rgba(0,0,0,0.5);">
            <div id="botonShareContainer" style="position: absolute; top: 10px; right: 10px;">
                <button class="btn-compartir" onclick="compartirCodigo()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
            </div>
            <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" style="height: 50px; margin-bottom: 10px;" crossorigin="anonymous">
            <div style="font-size: 20px; font-weight: bold; color: #111; margin-bottom: 5px;">SMART TRASLADOS</div>
            <div style="font-size: 12px; color: #666; font-weight: bold; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #ddd; width: 100%; padding-bottom: 10px;">VOUCHER DE ACTIVACI√ìN</div>
            <div style="font-size: 11px; color: #333; margin-bottom: 5px;">C√ìDIGO DE ACCESO:</div>
            <div id="txtFichaCodigo" class="ficha-codigo">000000</div>
            <div style="font-size: 12px; color: #000; font-weight: bold; margin-top: 15px; background: #e8f5e9; padding: 5px 10px; border-radius: 5px;">V√ÅLIDO POR 24 HORAS</div>
            <div style="font-size: 10px; color: #999; margin-top: 15px;">Smart Traslados - El control en tus manos.</div>
        </div>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas de la App</h3>
        <label>Precio base por viaje</label><input type="number" id="precioBase">
        <label>Precio por km</label><input type="number" id="precioKm">
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <label>Monto suscripci√≥n 24hs (Info)</label><input type="number" id="montoFijo">
        <button class="btn-ok" onclick="guardarTarifas()">Guardar en servidor</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Mensajer√≠a Masiva</h3>
        <select id="selectDestino">
            <option value="choferes">Todos los conductores</option>
            <option value="pasajeros">Todos los pasajeros</option>
        </select>
        <input type="text" id="msgMasivo" placeholder="Escrib√≠ el mensaje">
        <button class="btn-ok" onclick="enviarMensajeMasivo()">Enviar a todos</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n de Contacto</h3>
        <label>Nombre de la app</label><input id="confApp">
        <label>Tel√©fono soporte (Ej: 5492344123456)</label><input id="confTel">
        <label>Email soporte</label><input id="confMail">
        <label>Alias / CBU para Cobros</label><input id="confAlias">
        <button class="btn-ok" onclick="guardarConfiguracion()">Guardar configuraci√≥n</button>
    </div>
</div>

<script>
let listaUsuariosGlobal = [];
let listaViajesGlobal = [];

function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
    if(id === 'viajes') cargarViajesReales();
    if(id === 'estadisticas') { 
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('inputFechaEst').value = hoy;
        actualizarEstadisticasFecha();
    }
    if(id === 'tarifas') cargarTarifas();
    if(id === 'conductores' || id === 'pasajeros' || id === 'inicio') cargarDatosReales();
}

async function enviarMensajeMasivo() {
    const destino = document.getElementById('selectDestino').value;
    const texto = document.getElementById('msgMasivo').value;
    if(!texto) return alert("Escrib√≠ un mensaje primero");
    try {
        const res = await fetch('/enviar-mensaje-masivo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ destino, texto })
        });
        if(res.ok) {
            alert('¬°Mensaje enviado a la base de datos!');
            document.getElementById('msgMasivo').value = "";
        }
    } catch (e) { alert("Error de conexi√≥n"); }
}

async function cargarDatosReales() {
    try {
        const resV = await fetch('/obtener-viajes');
        listaViajesGlobal = await resV.json();

        const res = await fetch('/obtener-usuarios');
        listaUsuariosGlobal = await res.json();
        
        const conds = listaUsuariosGlobal.filter(u => 
            (u.rol && u.rol.toLowerCase().trim() === 'chofer') || 
            (u.autoPatente && u.autoPatente.trim() !== "")
        );
        
        const pasas = listaUsuariosGlobal.filter(u => 
            !conds.some(c => c.telefono === u.telefono)
        );

        document.getElementById('cActivos').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;
        actualizarTablaConductores(conds);
        actualizarTablaPasajeros(pasas);
    } catch (e) { console.error("Error cargando usuarios"); }
}

function actualizarTablaConductores(conds) {
    let tC = document.getElementById('tablaConductores');
    tC.innerHTML = `<tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr>`;
    conds.forEach(c => {
        const viajesDelChofer = listaViajesGlobal.filter(v => 
            v.choferTel === c.telefono && v.estado === "finalizado"
        );
        const totalRecaudado = viajesDelChofer.reduce((acc, v) => {
            const montoNum = parseInt(v.precio.replace(/[^0-9]/g, '')) || 0;
            return acc + montoNum;
        }, 0);

        const pagoAlDia = c.vencimientoPago && new Date(c.vencimientoPago) > new Date();
        const docOk = c.aprobado === true;
        const iconTrash = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
        const colorBotonTilde = docOk ? '#4caf50' : '#f44336';
        
        tC.innerHTML += `<tr id="fila-${c.telefono}">
            <td><a href="#" onclick="verPerfilCompleto('${c.telefono}')" style="color:#4caf50; text-decoration:none;"><b>${c.nombre || 'S/N'}</b></a><br><small>${c.telefono}</small></td>
            <td><span id="doc-${c.telefono}" class="${docOk?'estado-ok':'estado-pendiente'}">${docOk?'DOC: OK':'DOC: PEND'}</span><br><span class="${pagoAlDia?'estado-ok':'estado-off'}">${pagoAlDia?'PAGO: OK':'PAGO: VENC'}</span></td>
            <td style="color:#4caf50; font-weight:bold;">$${totalRecaudado.toLocaleString()}</td>
            <td><button id="btnTilde-${c.telefono}" class="btn-accion" style="background:${colorBotonTilde};" onclick="toggleDocumentacion('${c.telefono}', ${docOk})">‚úî</button><button class="btn-accion" style="background:#25d366;" onclick="window.open('https://wa.me/${c.telefono}')">‚úâ</button><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${c.telefono}')">${iconTrash}</button></td>
        </tr>`;
    });
}

function actualizarTablaPasajeros(pasas) {
    let tP = document.getElementById('tablaPasajeros');
    tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr>`;
    pasas.forEach(p => { 
        const estaBloqueado = p.bloqueado === true;
        const iconTrash = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
        const colorLock = estaBloqueado ? '#f44336' : '#ff9800';
        const nombreVisible = p.nombre || p.usuario || p.user || "Pasajero: " + p.telefono;
        tP.innerHTML += `<tr id="fila-${p.telefono}"><td><b style="color: #4caf50;">${nombreVisible}</b></td><td>${p.telefono}</td><td><button id="btnLock-${p.telefono}" class="btn-accion" style="background:${colorLock};" onclick="bloquearPasajero('${p.telefono}', ${estaBloqueado})">üîí</button><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${p.telefono}')">${iconTrash}</button></td></tr>`; 
    });
}

async function cargarViajesReales() {
    try {
        const res = await fetch('/obtener-viajes');
        listaViajesGlobal = await res.json();
        let tV = document.getElementById('tablaViajes');
        tV.innerHTML = `<tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Calif.</th><th>Estado</th><th>Acci√≥n</th></tr>`;
        listaViajesGlobal.forEach(v => {
            let color = v.estado === "finalizado" ? "#4caf50" : (v.estado === "cancelado" ? "#f44336" : "#ff9800");
            const iconTrash = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
            let estrellasTxt = v.estrellasPasajero && v.estrellasPasajero > 0 ? v.estrellasPasajero + " ‚≠ê" : "-";
            
            // Bot√≥n de finalizaci√≥n manual si el viaje est√° trabado
            let btnFinalizarManual = (v.estado === 'ACEPTADO' || v.estado === 'en viaje') 
                ? `<button class="btn-accion" style="background:#2e7d32;" onclick="finalizarViajeAdmin('${v._id}', '${v.precio}')">‚úÖ</button>` 
                : '';
            
            // Bot√≥n de contacto r√°pido con el chofer
            let btnWspChofer = v.choferTel ? `<button class="btn-accion" style="background:#25d366;" onclick="window.open('https://wa.me/${v.choferTel}')">‚úâ</button>` : '';

            tV.innerHTML += `<tr>
                <td>${v.fecha}</td>
                <td>${v.hora}</td>
                <td>${v.chofer || 'Buscando...'}</td>
                <td>${v.pasajero || 'S/N'}</td>
                <td style="color:#ffc107; font-weight:bold;">${estrellasTxt}</td>
                <td style="color:${color}; font-weight:bold;">${v.estado.toUpperCase()}</td>
                <td>
                    ${btnFinalizarManual}
                    ${btnWspChofer}
                    <button class="btn-accion" style="background:#f44336;" onclick="eliminarViajeHistorial('${v._id}')">${iconTrash}</button>
                </td>
            </tr>`;
        });
    } catch (e) { console.error("Error viajes"); }
}

async function finalizarViajeAdmin(id, precioSugerido) {
    const monto = prompt("¬øDeseas finalizar este viaje manualmente? Confirmar monto cobrado:", precioSugerido);
    if (monto !== null) {
        try {
            const res = await fetch('/finalizar-viaje-admin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ viajeId: id, monto: monto })
            });
            if (res.ok) {
                alert("Viaje finalizado correctamente.");
                cargarViajesReales();
            } else {
                alert("Error al intentar finalizar. Verifique el servidor.");
            }
        } catch (e) { alert("Error de red"); }
    }
}

async function eliminarViajeHistorial(id) {
    if(!confirm("¬øEliminar registro?")) return;
    try { await fetch('/eliminar-viaje', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); cargarViajesReales(); } catch (e) {}
}

async function actualizarEstadisticasFecha() {
    const fechaSel = document.getElementById('inputFechaEst').value;
    if(!fechaSel) return;
    try {
        const res = await fetch('/obtener-viajes');
        const viajes = await res.json();
        const partes = fechaSel.split('-');
        const fechaFormatoDB = `${parseInt(partes[1])}/${parseInt(partes[2])}/${partes[0]}`; 
        document.getElementById('tituloDia').innerText = `Demanda del d√≠a: ${partes[2]}/${partes[1]}/${partes[0]}`;
        let horasMap = {};
        for(let i=0; i<24; i++) horasMap[i.toString().padStart(2, '0') + ":00"] = 0;
        viajes.forEach(v => {
            if(v.fecha === fechaFormatoDB && v.hora) {
                let hStr = v.hora.split(":")[0];
                if(v.hora.includes("PM") && hStr !== "12") hStr = parseInt(hStr) + 12;
                if(v.hora.includes("AM") && hStr === "12") hStr = "00";
                let hFinal = hStr.toString().padStart(2, '0') + ":00";
                if(horasMap[hFinal] !== undefined) horasMap[hFinal]++;
            }
        });
        let tH = document.getElementById('tablaEstadisticasHoras');
        tH.innerHTML = `<tr><th>Franja Horaria</th><th>Viajes Solicitados</th></tr>`;
        Object.keys(horasMap).forEach(h => {
            let cant = horasMap[h];
            tH.innerHTML += `<tr><td>${h} hs</td><td style="${cant > 0 ? 'color:#4caf50; font-weight:bold;' : 'color:#555;'}">${cant}</td></tr>`;
        });
    } catch (e) {}
}

async function bloquearPasajero(tel, estadoActual) {
    const nuevoEstado = !estadoActual;
    try {
        await fetch('/bloquear-usuario', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel, bloqueado: nuevoEstado }) });
        cargarDatosReales();
    } catch(e) { cargarDatosReales(); }
}

async function eliminarUsuario(tel) {
    if(confirm("¬øEliminar definitivamente?")) {
        await fetch('/eliminar-usuario', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel }) });
        cargarDatosReales();
    }
}

async function toggleDocumentacion(tel, estadoActual) {
    const nuevoEstado = !estadoActual;
    try {
        await fetch('/aprobar-chofer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel, aprobado: nuevoEstado }) });
        cargarDatosReales();
    } catch(e) { cargarDatosReales(); }
}

function verPerfilCompleto(tel) {
    const u = listaUsuariosGlobal.find(user => user.telefono === tel);
    if(u) {
        document.getElementById('nomPerfil').innerText = "Perfil: " + (u.nombre || 'S/N');
        const setImg = (id, src) => {
            const el = document.getElementById(id);
            if(src && src.trim() !== "") { el.src = src; el.style.display = "block"; } else { el.src = ""; el.style.display = "none"; }
        };
        setImg('imgCarnet', u.fotoCarnet);
        setImg('imgSeguro', u.fotoSeguro);
        setImg('imgTarjeta', u.fotoTarjeta);
        document.getElementById('modalPerfil').style.display = 'block';
    }
}

function cerrarPerfil() { document.getElementById('modalPerfil').style.display = 'none'; }

async function cargarTarifas() {
    try {
        const res = await fetch('/obtener-tarifas');
        const data = await res.json();
        if(data) {
            document.getElementById('precioBase').value = data.precioBase || "";
            document.getElementById('precioKm').value = data.precioKm || "";
            if(data.montoFijoInfo) {
                document.getElementById('montoFijo').value = data.montoFijoInfo;
                localStorage.setItem('montoFijoInfo', data.montoFijoInfo);
            }
        }
    } catch (e) {}
}

async function guardarTarifas() {
    const pBase = parseInt(document.getElementById('precioBase').value);
    const pKm = parseInt(document.getElementById('precioKm').value);
    const mFijo = document.getElementById('montoFijo').value;
    if(!mFijo) return alert("El monto no puede estar vac√≠o.");
    try {
        const res = await fetch('/actualizar-tarifas', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ precioBase: pBase, precioKm: pKm, montoFijoInfo: mFijo }) 
        });
        if(res.ok) { localStorage.setItem('montoFijoInfo', mFijo); alert('Tarifas guardadas'); }
    } catch(e) {}
}

async function guardarConfiguracion() {
    const telLimpio = document.getElementById('confTel').value.replace(/\s+/g, '').replace('+', '');
    document.getElementById('confTel').value = telLimpio;
    const config = { 
        app: document.getElementById('confApp').value, 
        tel: telLimpio, 
        mail: document.getElementById('confMail').value, 
        alias: document.getElementById('confAlias').value 
    };
    try {
        const res = await fetch('/actualizar-config-admin', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(config) 
        });
        if(res.ok) {
            localStorage.setItem('configAdmin', JSON.stringify(config));
            alert('‚úÖ CONFIGURACI√ìN GUARDADA.');
        } else { alert('‚ùå EL SERVIDOR NO PUDO GUARDAR.'); }
    } catch(e) { alert("‚ùå ERROR DE RED."); }
}

async function generarNuevoCodigo() {
    const nuevoCod = Math.floor(100000 + Math.random() * 900000).toString();
    try {
        const res = await fetch('/crear-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codigo: nuevoCod }) });
        if(res.ok) { document.getElementById('txtFichaCodigo').innerText = nuevoCod; document.getElementById('contenedorFicha').style.display = 'flex'; }
    } catch (e) {}
}

async function compartirCodigo() {
    const elemento = document.getElementById('contenedorFicha');
    const btnShare = document.getElementById('botonShareContainer');
    const codigo = document.getElementById('txtFichaCodigo').innerText;
    btnShare.classList.add('ignore-capture');
    html2canvas(elemento, { backgroundColor: null, useCORS: true, scale: 2 }).then(async canvas => {
        btnShare.classList.remove('ignore-capture');
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], `voucher-${codigo}.png`, { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: 'Voucher Smart Traslados', text: `üöó *SMART TRASLADOS*\nC√≥digo: *${codigo}*` }); } catch (e) {}
        } else {
            const texto = `üöó *SMART TRASLADOS*\n\nHola! Tu c√≥digo de acceso es: *${codigo}*\n\nV√°lido por 24 horas.`;
            window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
        }
    });
}

window.onload = () => {
    cargarDatosReales();
    cargarTarifas();
    const config = JSON.parse(localStorage.getItem('configAdmin'));
    if(config) {
        document.getElementById('confApp').value = config.app || "";
        document.getElementById('confTel').value = config.tel || "";
        document.getElementById('confMail').value = config.mail || "";
        document.getElementById('confAlias').value = config.alias || "";
    }
    const montoBkp = localStorage.getItem('montoFijoInfo');
    if(montoBkp) document.getElementById('montoFijo').value = montoBkp;
};
</script>
</body>
</html>
