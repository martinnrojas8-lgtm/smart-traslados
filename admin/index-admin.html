<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; }
.menu{ display:flex; flex-wrap:wrap; background:#1a1a1a; }
.menu button{ flex:1; padding:15px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; }
input, select{ width:100%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background:#222; color:#fff; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:14px; }
.estado-ok{ color:#4caf50; }
.estado-off{ color:#f44336; }
.btn{ padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
.btn-ok{ background:#4caf50; }
.btn-del{ background:#f44336; }
/* Estilos extra para las funciones nuevas de fotos */
.btn-ver{ background:#2196f3; color:#fff; margin-right:5px; }
#modalFotos { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; overflow-y:auto; padding:20px; }
.modal-content { max-width:600px; margin:auto; background:#111; padding:20px; border-radius:10px; border:1px solid #333; }
.grid-fotos { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px; }
.grid-fotos img { width:100%; border-radius:5px; border:1px solid #333; cursor: pointer; }
.grid-fotos label { font-size:11px; color:#00c853; display:block; margin-bottom:4px; font-weight: bold; }
</style>
</head>

<body>

<header>üìä Smart Traslados ‚Äì Panel General</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="modalFotos">
    <div class="modal-content">
        <h3 id="docNombre" style="text-align: center;">Documentaci√≥n</h3>
        <div class="grid-fotos" id="contenedorFotos"></div>
        <button class="btn btn-del" style="width:100%; margin-top:20px; padding: 15px;" onclick="document.getElementById('modalFotos').style.display='none'">CERRAR VISTA</button>
    </div>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card">
        <h3>Resumen general</h3>
        <p>Conductores activos: <b id="cActivos">0</b></p>
        <p>Pasajeros registrados: <b id="pTotal">0</b></p>
        <p>Viajes del d√≠a: <b id="vHoy">0</b></p>
        <p>Ganancia estimada hoy: <b>$ <span id="gHoy">0</span></b></p>
        <p>Monto fijo recaudado hoy: <b>$ <span id="montoHoy">0</span></b></p>
    </div>
</div>

<div id="conductores" class="pantalla">
    <div class="card">
        <h3>Conductores</h3>
        <table id="tablaConductores">
            <tr><th>Nombre</th><th>Tel√©fono</th><th>Estado</th><th>Acci√≥n</th></tr>
        </table>
    </div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card">
        <h3>Pasajeros</h3>
        <table id="tablaPasajeros">
            <tr><th>Nombre</th><th>Tel√©fono</th><th>Viajes</th></tr>
        </table>
    </div>
</div>

<div id="viajes" class="pantalla">
    <div class="card">
        <h3>Historial de viajes</h3>
        <table id="tablaViajes">
            <tr><th>Fecha</th><th>Chofer</th><th>Pasajero</th><th>Monto</th></tr>
        </table>
    </div>
</div>

<div id="pagos" class="pantalla">
    <div class="card">
        <h3>Historial de cobros por choferes</h3>
        <label>Filtrar por chofer:</label>
        <select id="filtroChofer" onchange="cargarPagos()"><option value="">Todos</option></select>
        <label>Filtrar por fecha:</label>
        <input type="date" id="filtroFecha" onchange="cargarPagos()">
        <table id="tablaPagos">
            <tr><th>Chofer</th><th>Monto total</th><th>Saldo bancario recibido</th></tr>
        </table>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card" style="border: 2px dashed #00c853; margin-bottom: 15px;">
        <h3 style="color:#00c853;">Generar C√≥digo de Activaci√≥n</h3>
        <button class="btn btn-ok" style="width:100%; font-weight:bold; padding: 12px;" onclick="generarToken()">CREAR C√ìDIGO NUEVO</button>
        <div id="tokenResultado" style="text-align:center; font-size:28px; margin-top:10px; color:#00c853; font-weight:bold; letter-spacing:5px;"></div>
    </div>
    <div class="card">
        <h3>Tarifas</h3>
        <label>Precio base por viaje</label>
        <input type="number" id="precioBase" value="500">
        <label>Precio por km</label>
        <input type="number" id="precioKm" value="150">
        <label>Monto fijo para conectarse</label>
        <input type="number" id="montoFijo" value="10000">
        <button class="btn btn-ok" onclick="guardarTarifas()">Guardar cambios</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Enviar mensaje</h3>
        <select><option>Todos los conductores</option><option>Todos los pasajeros</option></select>
        <input type="text" placeholder="Escrib√≠ el mensaje">
        <button class="btn btn-ok">Enviar</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n general</h3>
        <label>Nombre de la app</label>
        <input id="appName" value="Smart Traslados">
        <label>Tel√©fono soporte</label>
        <input id="soporteTel" value="+54 9">
        <label>Email soporte</label>
        <input id="soporteEmail" value="soporte@smart.com">
        <label>Cuenta bancaria para recibir pagos (token/ID)</label>
        <input id="cuentaBancaria" placeholder="Ingres√° tu token o ID">
        <button class="btn btn-ok" onclick="guardarCuentaBancaria()">Guardar cuenta bancaria</button>
        <button class="btn btn-ok" onclick="mostrarCuenta()">Ver cuenta bancaria vinculada</button>
    </div>
</div>

<script>
// --- L√≥gica de Datos Reales ---
let conductores = [];
let pasajeros = [];
let viajes = []; 
let tarifas = {precioBase:500, precioKm:150, montoFijo:10000};
let pagosBancarios = JSON.parse(localStorage.getItem('pagosBancarios')) || {};

function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
    cargarTodo();
}

async function cargarTodo(){
    try {
        const res = await fetch('/obtener-usuarios');
        const usuarios = await res.json();
        conductores = usuarios.filter(u => u.tipo === 'chofer');
        pasajeros = usuarios.filter(u => u.tipo === 'pasajero');

        // Tus c√°lculos originales exactos
        document.getElementById('cActivos').innerText = conductores.filter(c=>c.pagoActivo).length;
        document.getElementById('pTotal').innerText = pasajeros.length;
        document.getElementById('vHoy').innerText = viajes.length;
        document.getElementById('gHoy').innerText = viajes.reduce((a,v)=>a+v.monto*0.15,0);

        let hoy = new Date().toISOString().slice(0,10);
        let totalMontoHoy = viajes.filter(v=>v.fecha.startsWith(hoy)).reduce((a,v)=>a+tarifas.montoFijo,0);
        document.getElementById('montoHoy').innerText = totalMontoHoy;

        actualizarTablaConductores();
        actualizarTablaPasajeros();
        cargarPagos();
    } catch (e) { console.error("Error conectando al server"); }
}

function actualizarTablaConductores(){
    let tabla = document.getElementById('tablaConductores');
    tabla.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Estado</th><th>Acci√≥n</th></tr>`;
    let filtroChofer = document.getElementById('filtroChofer');
    let valPrevio = filtroChofer.value;
    filtroChofer.innerHTML = `<option value="">Todos</option>`;

    conductores.forEach(c=>{
        tabla.innerHTML += `
        <tr>
            <td>${c.nombre || 'S/N'}</td>
            <td>${c.telefono}</td>
            <td class="${c.pagoActivo?'estado-ok':'estado-off'}">${c.pagoActivo?'Activo':'Bloqueado'}</td>
            <td>
                <button class="btn btn-ver" onclick="verFotos('${c.telefono}')">FOTOS</button>
                <button class="btn btn-del" style="color:white" onclick="toggleAcceso('${c.telefono}', ${c.pagoActivo})">CAMBIAR</button>
            </td>
        </tr>`;
        filtroChofer.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
    });
    filtroChofer.value = valPrevio;
}

function actualizarTablaPasajeros(){
    let tabla = document.getElementById('tablaPasajeros');
    tabla.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Viajes</th></tr>`;
    pasajeros.forEach(p=>{
        tabla.innerHTML += `<tr><td>${p.nombre || 'S/N'}</td><td>${p.telefono}</td><td>0</td></tr>`;
    });
}

// --- Tu L√≥gica de Pagos y Filtros (Sin cambios) ---
function cargarPagos(){
    let tabla = document.getElementById('tablaPagos');
    let filtroChofer = document.getElementById('filtroChofer').value;
    let filtroFecha = document.getElementById('filtroFecha').value;
    tabla.innerHTML = `<tr><th>Chofer</th><th>Monto total</th><th>Saldo bancario recibido</th></tr>`;
    
    let choferesFiltrados = filtroChofer ? conductores.filter(c=>c.nombre===filtroChofer) : conductores;

    choferesFiltrados.forEach(c=>{
        let totalViajes = viajes.filter(v=>v.chofer===c.nombre).filter(v=>!filtroFecha || v.fecha.startsWith(filtroFecha)).reduce((a,v)=>a+v.monto,0);
        let saldoBanco = pagosBancarios[c.telefono] || 0;
        tabla.innerHTML += `<tr><td>${c.nombre || c.telefono}</td><td>$${totalViajes}</td><td>$${saldoBanco}</td></tr>`;
    });
}

// --- Funciones Nuevas de Servidor ---
async function toggleAcceso(tel, estadoActual){
    await fetch('/actualizar-perfil-chofer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ telefono: tel, pagoActivo: !estadoActual })
    });
    cargarTodo();
}

async function generarToken() {
    const cod = Math.floor(100000 + Math.random() * 900000).toString();
    const res = await fetch('/crear-token', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ codigo: cod })
    });
    if(res.ok) document.getElementById('tokenResultado').innerText = cod;
}

function verFotos(tel) {
    const c = conductores.find(u => u.telefono === tel);
    document.getElementById('docNombre').innerText = "Documentos: " + (c.nombre || c.telefono);
    document.getElementById('contenedorFotos').innerHTML = `
        <div><label>Perfil</label><img src="${c.foto||''}" style="width:100%" onclick="window.open(this.src)"></div>
        <div><label>Carnet</label><img src="${c.fotoCarnet||''}" style="width:100%" onclick="window.open(this.src)"></div>
        <div><label>Seguro</label><img src="${c.fotoSeguro||''}" style="width:100%" onclick="window.open(this.src)"></div>
        <div><label>Tarjeta</label><img src="${c.fotoTarjeta||''}" style="width:100%" onclick="window.open(this.src)"></div>
    `;
    document.getElementById('modalFotos').style.display = 'block';
}

// --- Tus Funciones de Guardado (Sin cambios) ---
function guardarTarifas(){ alert('Tarifas guardadas correctamente'); }
function guardarCuentaBancaria(){ 
    localStorage.setItem('cuentaBancaria', document.getElementById('cuentaBancaria').value);
    alert('Cuenta bancaria vinculada'); 
}
function mostrarCuenta(){ alert('Cuenta: ' + (localStorage.getItem('cuentaBancaria') || 'No vinculada')); }

window.onload = cargarTodo;
</script>
</body>
</html>
