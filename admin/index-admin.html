<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; border-bottom: 2px solid #4caf50; display: flex; align-items: center; justify-content: center; gap: 10px; }
.logo-header { height: 35px; width: auto; border-radius: 5px; }
.menu{ display:flex; overflow-x: auto; background:#1a1a1a; white-space: nowrap; border-bottom: 1px solid #333; }
.menu button{ padding:15px 20px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; flex-shrink: 0; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #333; }
input, select{ width:95%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background: #fff; color: #000; font-weight: bold; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:13px; }
.estado-ok{ color:#4caf50; font-weight: bold; }
.estado-off{ color:#f44336; font-weight: bold; }
.estado-pendiente { color: #ff9800; font-weight: bold; }
.btn-ok{ background:#4caf50; color: #fff; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
.btn-accion{ padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; margin-right: 2px; }
#modalPerfil { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow-y:auto; padding:20px; }
.modal-contenido { background:#111; padding:20px; border-radius:10px; border:1px solid #4caf50; max-width:500px; margin:auto; }
.foto-legajo { width:100%; border-radius:8px; margin-bottom:15px; border:1px solid #333; }
.ficha-codigo { font-size: 42px; font-weight: bold; color: #4caf50; letter-spacing: 5px; margin: 5px 0; }
</style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" class="logo-header" alt="logo">
    <span>Smart Traslados ‚Äì Admin</span>
</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="modalPerfil"><div class="modal-contenido"><h3 id="nomPerfil" style="margin-top:0; color:#4caf50;"></h3><p><b>Carnet de Conducir:</b></p><img id="imgCarnet" class="foto-legajo"><p><b>Seguro:</b></p><img id="imgSeguro" class="foto-legajo"><p><b>Tarjeta del Auto:</b></p><img id="imgTarjeta" class="foto-legajo"><button class="btn-ok" onclick="cerrarPerfil()">CERRAR PERFIL</button></div></div>

<div id="inicio" class="pantalla activa">
    <div class="card"><h3>Resumen operativo</h3><p>Conductores registrados: <b id="cActivos">0</b></p><p>Pasajeros registrados: <b id="pTotal">0</b></p></div>
</div>

<div id="conductores" class="pantalla">
    <div class="card"><h3>Gesti√≥n de Conductores</h3><div style="overflow-x:auto;"><table id="tablaConductores"><tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card"><h3>Lista de Pasajeros</h3><div style="overflow-x:auto;"><table id="tablaPasajeros"><tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="viajes" class="pantalla">
    <div class="card"><h3>Historial de Viajes Reales</h3><div style="overflow-x:auto;"><table id="tablaViajes"><tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Estado</th></tr></table></div></div>
</div>

<div id="pagos" class="pantalla">
    <div class="card" style="text-align:center;">
        <h3>Generar Pin de Activaci√≥n 24hs</h3>
        <button class="btn-ok" onclick="generarNuevoCodigo()">GENERAR NUEVO C√ìDIGO</button>
        
        <div id="contenedorFicha" style="display: none; flex-direction: column; align-items: center; background: #fff; padding: 25px; border-radius: 15px; max-width: 300px; margin: 25px auto; color: #000; text-align: center; border: 3px solid #4caf50; box-shadow: 0 10px 20px rgba(0,0,0,0.5);">
            <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" style="height: 50px; margin-bottom: 10px;">
            <div style="font-size: 20px; font-weight: bold; color: #111; margin-bottom: 5px;">SMART TRASLADOS</div>
            <div style="font-size: 12px; color: #666; font-weight: bold; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #ddd; width: 100%; padding-bottom: 10px;">VOUCHER DE ACTIVACI√ìN</div>
            <div style="font-size: 11px; color: #333; margin-bottom: 5px;">C√ìDIGO DE ACCESO:</div>
            <div id="txtFichaCodigo" class="ficha-codigo">000000</div>
            <div style="font-size: 12px; color: #000; font-weight: bold; margin-top: 15px; background: #e8f5e9; padding: 5px 10px; border-radius: 5px;">V√ÅLIDO POR 24 HORAS</div>
            <div style="font-size: 10px; color: #999; margin-top: 15px;">Smart Traslados - El control en tus manos.</div>
        </div>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas de la App</h3>
        <label>Precio base por viaje</label><input type="number" id="precioBase">
        <label>Precio por km</label><input type="number" id="precioKm">
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <label>Monto suscripci√≥n 24hs (Info)</label><input type="number" id="montoFijo">
        <button class="btn-ok" onclick="guardarTarifas()">Guardar en servidor</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Mensajer√≠a Masiva</h3>
        <select id="selectDestino"><option value="choferes">Todos los conductores</option><option value="pasajeros">Todos los pasajeros</option></select>
        <input type="text" id="msgMasivo" placeholder="Escrib√≠ el mensaje">
        <button class="btn-ok" onclick="alert('Mensaje enviado')">Enviar a todos</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n de Contacto</h3>
        <label>Nombre de la app</label><input id="confApp">
        <label>Tel√©fono soporte</label><input id="confTel">
        <label>Email soporte</label><input id="confMail">
        <label>Alias / CBU para Cobros</label><input id="confAlias">
        <button class="btn-ok" onclick="guardarConfiguracion()">Guardar configuraci√≥n</button>
    </div>
</div>

<script>
let listaUsuariosGlobal = [];

function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
    if(id === 'viajes') cargarViajesReales();
    if(id === 'tarifas') cargarTarifas();
    if(id === 'conductores' || id === 'pasajeros') cargarDatosReales();
}

async function cargarDatosReales() {
    try {
        const res = await fetch('/obtener-usuarios');
        listaUsuariosGlobal = await res.json();
        const conds = listaUsuariosGlobal.filter(u => u.rol === 'chofer');
        const pasas = listaUsuariosGlobal.filter(u => u.rol === 'pasajero');
        document.getElementById('cActivos').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;
        actualizarTablaConductores(conds);
        actualizarTablaPasajeros(pasas);
    } catch (e) { console.error("Error cargando usuarios"); }
}

function actualizarTablaConductores(conds) {
    let tC = document.getElementById('tablaConductores');
    tC.innerHTML = `<tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr>`;
    conds.forEach(c => {
        const pagoAlDia = c.vencimientoPago && new Date(c.vencimientoPago) > new Date();
        const docOk = c.aprobado === true;
        tC.innerHTML += `<tr id="fila-${c.telefono}"><td><a href="#" onclick="verPerfilCompleto('${c.telefono}')" style="color:#4caf50; text-decoration:none;"><b>${c.nombre || 'S/N'}</b></a><br><small>${c.telefono}</small></td><td><span id="doc-${c.telefono}" class="${docOk?'estado-ok':'estado-pendiente'}">${docOk?'DOC: OK':'DOC: PEND'}</span><br><span class="${pagoAlDia?'estado-ok':'estado-off'}">${pagoAlDia?'PAGO: OK':'PAGO: VENC'}</span></td><td>$0</td><td><button class="btn-accion" style="background:${docOk ? '#f44336' : '#4caf50'};" onclick="aprobarDocumentacion('${c.telefono}', ${docOk})">${docOk ? '‚úï' : '‚úî'}</button><button class="btn-accion" style="background:#25d366;" onclick="window.open('https://wa.me/${c.telefono}')">‚úâ</button><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${c.telefono}')">üóë</button></td></tr>`;
    });
}

function actualizarTablaPasajeros(pasas) {
    let tP = document.getElementById('tablaPasajeros');
    tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr>`;
    pasas.forEach(p => { 
        const estaBloqueado = (p.bloqueado === true);
        tP.innerHTML += `<tr id="fila-${p.telefono}"><td>${p.nombre || 'S/N'}</td><td>${p.telefono}</td><td><button id="btnLock-${p.telefono}" class="btn-accion" style="background:${estaBloqueado ? '#f44336' : '#4caf50'};" onclick="bloquearPasajero('${p.telefono}', ${estaBloqueado})">${estaBloqueado ? 'üîì' : 'üîí'}</button><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${p.telefono}')">üóë</button></td></tr>`; 
    });
}

async function cargarViajesReales() {
    try {
        const res = await fetch('/obtener-viajes');
        const viajes = await res.json();
        let tV = document.getElementById('tablaViajes');
        tV.innerHTML = `<tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Estado</th></tr>`;
        viajes.forEach(v => {
            let color = "#ff9800";
            if(v.estado === "finalizado") color = "#4caf50";
            if(v.estado === "cancelado") color = "#f44336";
            tV.innerHTML += `<tr><td>${v.fecha}</td><td>${v.hora}</td><td>${v.chofer || 'Buscando...'}</td><td>${v.pasajero || 'S/N'}</td><td style="color:${color}; font-weight:bold;">${v.estado.toUpperCase()}</td></tr>`;
        });
    } catch (e) { console.error("Error viajes"); }
}

async function bloquearPasajero(tel, actualmenteBloqueado) {
    const nuevaAccion = actualmenteBloqueado ? "desbloquear" : "bloquear";
    if(confirm(`¬øDesea ${nuevaAccion} a este pasajero?`)) {
        try {
            const res = await fetch('/bloquear-usuario', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ telefono: tel, estado: !actualmenteBloqueado }) 
            });
            await cargarDatosReales();
        } catch (e) { alert("Error de conexi√≥n"); }
    }
}

async function eliminarUsuario(tel) {
    if(confirm("¬øEliminar definitivamente?")) {
        try {
            const res = await fetch('/eliminar-usuario', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel }) });
            await cargarDatosReales();
        } catch (e) { alert("Error al eliminar"); }
    }
}

async function aprobarDocumentacion(tel, actualmenteAprobado) {
    const nuevaAccion = actualmenteAprobado ? "desaprobar" : "aprobar";
    if(confirm(`¬øDesea ${nuevaAccion} la documentaci√≥n?`)) {
        try {
            const res = await fetch('/aprobar-chofer', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ telefono: tel, aprobado: !actualmenteAprobado }) 
            });
            await cargarDatosReales();
        } catch (e) { alert("Error de conexi√≥n"); }
    }
}

function verPerfilCompleto(tel) {
    const u = listaUsuariosGlobal.find(u => u.telefono === tel);
    if(u) {
        document.getElementById('nomPerfil').innerText = "Perfil: " + (u.nombre || 'S/N');
        document.getElementById('imgCarnet').src = u.fotoCarnet || '';
        document.getElementById('imgSeguro').src = u.fotoSeguro || '';
        document.getElementById('imgTarjeta').src = u.fotoTarjeta || '';
        document.getElementById('modalPerfil').style.display = 'block';
    }
}
function cerrarPerfil() { document.getElementById('modalPerfil').style.display = 'none'; }

async function cargarTarifas() {
    try {
        const res = await fetch('/obtener-tarifas');
        const data = await res.json();
        document.getElementById('precioBase').value = data.precioBase || "";
        document.getElementById('precioKm').value = data.precioKm || "";
        document.getElementById('montoFijo').value = localStorage.getItem('montoFijoInfo') || "";
    } catch (e) {}
}

async function guardarTarifas() {
    const pBase = parseInt(document.getElementById('precioBase').value);
    const pKm = parseInt(document.getElementById('precioKm').value);
    await fetch('/actualizar-tarifas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ precioBase: pBase, precioKm: pKm }) });
    localStorage.setItem('montoFijoInfo', document.getElementById('montoFijo').value);
    alert('Tarifas guardadas');
}

function guardarConfiguracion() {
    const config = { app: document.getElementById('confApp').value, tel: document.getElementById('confTel').value, mail: document.getElementById('confMail').value, alias: document.getElementById('confAlias').value };
    localStorage.setItem('configAdmin', JSON.stringify(config));
    alert('Configuraci√≥n guardada');
}

async function generarNuevoCodigo() {
    const nuevoCod = Math.floor(100000 + Math.random() * 900000).toString();
    try {
        const res = await fetch('/crear-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codigo: nuevoCod }) });
        if(res.ok) { document.getElementById('txtFichaCodigo').innerText = nuevoCod; document.getElementById('contenedorFicha').style.display = 'flex'; }
    } catch (e) { alert("Error al generar c√≥digo"); }
}

window.onload = () => {
    cargarDatosReales();
    cargarTarifas();
    const config = JSON.parse(localStorage.getItem('configAdmin'));
    if(config) {
        document.getElementById('confApp').value = config.app || "";
        document.getElementById('confTel').value = config.tel || "";
        document.getElementById('confMail').value = config.mail || "";
        document.getElementById('confAlias').value = config.alias || "";
    }
};
</script>
</body>
</html>
