<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados â€“ Panel Propietario</title>
<style>
/* MANTENEMOS TODO TU CSS IGUAL */
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; }
.menu{ display:flex; flex-wrap:wrap; background:#1a1a1a; }
.menu button{ flex:1; padding:15px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; }
input, select{ width:100%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background:#222; color:#fff; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:14px; }
.estado-ok{ color:#4caf50; }
.estado-off{ color:#f44336; }
.btn{ padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.btn-ok{ background:#4caf50; color:#000; }
.btn-del{ background:#f44336; color:#fff; margin-left:5px; }
.btn-warn{ background:#ffb300; color:#000; }
</style>
</head>
<body>

<header>ðŸ“Š Smart Traslados â€“ Panel General</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">ConfiguraciÃ³n</button>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card">
        <h3>Resumen real de base de datos</h3>
        <p>Conductores activos: <b id="cActivos">Cargando...</b></p>
        <p>Pasajeros registrados: <b id="pTotal">Cargando...</b></p>
        <p>Viajes del dÃ­a: <b id="vHoy">0</b></p>
        <p>Monto fijo recaudado hoy: <b>$ <span id="montoHoy">0</span></b></p>
    </div>
</div>

<div id="conductores" class="pantalla">
    <div class="card">
        <h3>Conductores Registrados</h3>
        <table id="tablaConductores">
            <tr><th>Nombre</th><th>TelÃ©fono</th><th>Estado</th><th>AcciÃ³n</th></tr>
        </table>
    </div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card">
        <h3>Pasajeros Registrados</h3>
        <table id="tablaPasajeros">
            <tr><th>Nombre</th><th>TelÃ©fono</th><th>AcciÃ³n</th></tr>
        </table>
    </div>
</div>

<div id="viajes" class="pantalla"><div class="card"><h3>Historial de viajes</h3><p>PrÃ³ximamente conexiÃ³n con base de datos de viajes.</p></div></div>
<div id="pagos" class="pantalla"><div class="card"><h3>Historial de cobros</h3></div></div>
<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas</h3>
        <label>Monto fijo para conectarse</label>
        <input type="number" id="montoFijo" value="10000">
        <button class="btn btn-ok" onclick="alert('Tarifas guardadas')">Guardar cambios</button>
    </div>
</div>

<script>
let usuariosDB = [];

function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
    if(id === 'inicio' || id === 'conductores' || id === 'pasajeros') cargarDatosReales();
}

async function cargarDatosReales() {
    try {
        const res = await fetch('/admin/obtener-usuarios');
        usuariosDB = await res.json();
        
        // Filtrar por rol
        const choferes = usuariosDB.filter(u => u.rol === 'chofer');
        const pasajeros = usuariosDB.filter(u => u.rol === 'pasajero');

        // Actualizar Inicio
        document.getElementById('cActivos').innerText = choferes.filter(c => c.estadoRevision === 'aprobado').length;
        document.getElementById('pTotal').innerText = pasajeros.length;

        // Renderizar Tablas
        renderizarChoferes(choferes);
        renderizarPasajeros(pasajeros);
    } catch (e) {
        console.error("Error al cargar datos:", e);
    }
}

function renderizarChoferes(lista) {
    let tabla = document.getElementById('tablaConductores');
    tabla.innerHTML = `<tr><th>Nombre</th><th>TelÃ©fono</th><th>Estado</th><th>AcciÃ³n</th></tr>`;
    lista.forEach(c => {
        const esAprobado = c.estadoRevision === 'aprobado';
        tabla.innerHTML += `
        <tr>
            <td>${c.nombre || 'Sin completar'}</td>
            <td>${c.telefono}</td>
            <td class="${esAprobado?'estado-ok':'estado-off'}">${c.estadoRevision.toUpperCase()}</td>
            <td>
                <button class="btn btn-ok" onclick="cambiarEstado('${c.telefono}', 'aprobado')">âœ…</button>
                <button class="btn btn-warn" onclick="cambiarEstado('${c.telefono}', 'suspendido')">ðŸš«</button>
                <button class="btn btn-del" onclick="eliminarUsuario('${c.telefono}')">ðŸ—‘</button>
            </td>
        </tr>`;
    });
}

function renderizarPasajeros(lista) {
    let tabla = document.getElementById('tablaPasajeros');
    tabla.innerHTML = `<tr><th>Nombre</th><th>TelÃ©fono</th><th>AcciÃ³n</th></tr>`;
    lista.forEach(p => {
        tabla.innerHTML += `
        <tr>
            <td>${p.nombre || 'Nuevo Pasajero'}</td>
            <td>${p.telefono}</td>
            <td>
                <button class="btn btn-del" onclick="eliminarUsuario('${p.telefono}')">Eliminar</button>
            </td>
        </tr>`;
    });
}

async function cambiarEstado(tel, nuevoEstado) {
    await fetch('/admin/cambiar-estado', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ telefono: tel, nuevoEstado: nuevoEstado })
    });
    cargarDatosReales();
}

async function eliminarUsuario(tel) {
    if(!confirm("Â¿Eliminar usuario permanentemente?")) return;
    await fetch('/admin/eliminar-usuario/' + tel, { method: 'DELETE' });
    cargarDatosReales();
}

// Inicializar
window.onload = cargarDatosReales;
</script>
</body>
</html>
