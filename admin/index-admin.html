<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; border-bottom: 2px solid #00c853; }
.menu{ display:flex; flex-wrap:wrap; background:#1a1a1a; }
.menu button{ flex:1; padding:15px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; border-bottom: 1px solid #333; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #333; }
input, select{ width:100%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background: #222; color: #fff; box-sizing: border-box; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:14px; }
.estado-ok{ color:#4caf50; }
.estado-off{ color:#f44336; }
.btn{ padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight: bold; width: 100%; margin-top: 10px; }
.btn-ok{ background:#00c853; color: #000; }
.btn-del{ background:#f44336; color: #fff; }
</style>
</head>

<body>

<header>üìä Smart Traslados ‚Äì Panel General</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card">
        <h3>Resumen general</h3>
        <p>Conductores registrados: <b id="cTotal">0</b></p>
        <p>Pasajeros registrados: <b id="pTotal">0</b></p>
    </div>
</div>

<div id="conductores" class="pantalla">
    <div class="card">
        <h3>Conductores registrados</h3>
        <table id="tablaConductores">
            <tr>
                <th>Nombre</th>
                <th>Tel√©fono</th>
                <th>Estado Pago</th>
            </tr>
        </table>
    </div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card">
        <h3>Pasajeros registrados</h3>
        <table id="tablaPasajeros">
            <tr>
                <th>Nombre</th>
                <th>Tel√©fono</th>
            </tr>
        </table>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n de Tarifas</h3>
        <label>Precio base (Hasta 4 km)</label>
        <input type="number" id="precioBase" placeholder="Ej: 3500">
        <label>Precio por km adicional</label>
        <input type="number" id="precioKm" placeholder="Ej: 900">
        <button class="btn btn-ok" id="btnGuardarTarifas" onclick="guardarTarifas()">GUARDAR EN BASE DE DATOS</button>
    </div>
</div>

<div id="viajes" class="pantalla"><div class="card"><h3>Pr√≥ximamente: Historial de viajes</h3></div></div>
<div id="pagos" class="pantalla"><div class="card"><h3>Pr√≥ximamente: Historial de cobros</h3></div></div>
<div id="mensajes" class="pantalla"><div class="card"><h3>Enviar notificaciones</h3></div></div>
<div id="config" class="pantalla"><div class="card"><h3>Configuraci√≥n del Sistema</h3></div></div>

<script>
function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
}

// 1. CARGAR TARIFAS DESDE EL SERVIDOR AL ABRIR
async function cargarTarifasAdmin() {
    try {
        const res = await fetch('/obtener-tarifas');
        const data = await res.json();
        document.getElementById('precioBase').value = data.precioBase || 3500;
        document.getElementById('precioKm').value = data.precioKm || 900;
    } catch (e) { console.error("Error cargando tarifas"); }
}

// 2. GUARDAR TARIFAS EN EL SERVIDOR (MONGODB)
async function guardarTarifas() {
    const pBase = parseInt(document.getElementById('precioBase').value);
    const pKm = parseInt(document.getElementById('precioKm').value);

    if(!pBase || !pKm) return alert("Por favor completa los precios");

    const btn = document.getElementById('btnGuardarTarifas');
    btn.innerText = "GUARDANDO...";
    btn.disabled = true;

    try {
        const res = await fetch('/actualizar-tarifas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precioBase: pBase, precioKm: pKm })
        });
        const data = await res.json();
        if(data.mensaje === "Ok") {
            alert("‚úÖ Tarifas actualizadas en todo el sistema");
        }
    } catch (e) {
        alert("‚ùå Error al conectar con el servidor");
    } finally {
        btn.innerText = "GUARDAR EN BASE DE DATOS";
        btn.disabled = false;
    }
}

// 3. CARGAR DATOS DE USUARIOS DESDE MONGODB
async function cargarDatosGlobales() {
    try {
        const res = await fetch('/obtener-usuarios');
        const usuarios = await res.json();

        const conds = usuarios.filter(u => u.rol === 'chofer');
        const pasas = usuarios.filter(u => u.rol === 'pasajero');

        document.getElementById('cTotal').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;

        // Tabla Conductores
        let tC = document.getElementById('tablaConductores');
        tC.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Estado Pago</th></tr>`;
        conds.forEach(c => {
            tC.innerHTML += `<tr>
                <td>${c.nombre || 'S/N'}</td>
                <td>${c.telefono}</td>
                <td class="${c.pagoActivo?'estado-ok':'estado-off'}">${c.pagoActivo?'Al d√≠a':'Pendiente'}</td>
            </tr>`;
        });

        // Tabla Pasajeros
        let tP = document.getElementById('tablaPasajeros');
        tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th></tr>`;
        pasas.forEach(p => {
            tP.innerHTML += `<tr>
                <td>${p.nombre || 'S/N'}</td>
                <td>${p.telefono}</td>
            </tr>`;
        });

    } catch (e) { console.error("Error cargando usuarios"); }
}

// INICIO AUTOM√ÅTICO
window.onload = () => {
    cargarTarifasAdmin();
    cargarDatosGlobales();
};
</script>

</body>
</html>
