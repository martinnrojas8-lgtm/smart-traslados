<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png">

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; border-bottom: 2px solid #4caf50; display: flex; align-items: center; justify-content: center; gap: 10px; }
.logo-header { height: 35px; width: auto; border-radius: 5px; }
.menu{ display:flex; overflow-x: auto; background:#1a1a1a; white-space: nowrap; border-bottom: 1px solid #333; }
.menu button{ padding:15px 20px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; flex-shrink: 0; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #333; }
input, select{ width:95%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background: #fff; color: #000; font-weight: bold; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:10px; border-bottom:1px solid #333; text-align:left; font-size:13px; }
.estado-ok{ color:#4caf50; font-weight: bold; }
.estado-off{ color:#f44336; font-weight: bold; }
.estado-pendiente { color: #ff9800; font-weight: bold; }
.btn-ok{ background:#4caf50; color: #fff; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
.btn-accion{ padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; margin-right: 2px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; min-width: 35px; }
#modalPerfil { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow-y:auto; padding:20px; }
.modal-contenido { background:#111; padding:20px; border-radius:10px; border:1px solid #4caf50; max-width:500px; margin:auto; }
.foto-legajo { width:100%; max-height: 400px; object-fit: contain; border-radius:8px; margin-bottom:15px; border:1px solid #333; background: #000; }
.ficha-codigo { font-size: 42px; font-weight: bold; color: #4caf50; letter-spacing: 5px; margin: 5px 0; }
</style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" class="logo-header" alt="logo">
    <span>Smart Traslados ‚Äì Admin</span>
</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('estadisticas')">Estad√≠sticas</button>
    <button onclick="mostrar('pagos')">Generar PIN</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="modalPerfil">
  <div class="modal-contenido">
    <h3 id="nomPerfil" style="margin-top:0; color:#4caf50;"></h3>
    <p><b>Carnet de Conducir:</b></p>
    <img id="imgCarnet" class="foto-legajo" alt="Sin cargar">
    <p><b>Seguro:</b></p>
    <img id="imgSeguro" class="foto-legajo" alt="Sin cargar">
    <p><b>Tarjeta del Auto:</b></p>
    <img id="imgTarjeta" class="foto-legajo" alt="Sin cargar">
    <button class="btn-ok" onclick="cerrarPerfil()">CERRAR PERFIL</button>
  </div>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card"><h3>Resumen operativo</h3><p>Conductores registrados: <b id="cActivos">0</b></p><p>Pasajeros registrados: <b id="pTotal">0</b></p></div>
</div>

<div id="conductores" class="pantalla">
    <div class="card"><h3>Gesti√≥n de Conductores</h3><div style="overflow-x:auto;"><table id="tablaConductores"><tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card"><h3>Lista de Pasajeros</h3><div style="overflow-x:auto;"><table id="tablaPasajeros"><tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="viajes" class="pantalla">
    <div class="card"><h3>Historial de Viajes Reales</h3><div style="overflow-x:auto;"><table id="tablaViajes"><tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Calif.</th><th>Estado</th><th>Acci√≥n</th></tr></table></div></div>
</div>

<div id="estadisticas" class="pantalla">
    <div class="card">
        <h3>Consultar Demanda por Fecha</h3>
        <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Seleccion√° un d√≠a del calendario para ver el detalle horario.</p>
        <input type="date" id="inputFechaEst" onchange="actualizarEstadisticasFecha()" style="margin-bottom: 20px;">
        <h4 id="tituloDia" style="color:#4caf50; border-bottom: 1px solid #333; padding-bottom: 5px;">Seleccione una fecha</h4>
        <div style="overflow-x:auto;"><table id="tablaEstadisticasHoras"><tr><th>Franja Horaria</th><th>Viajes Solicitados</th></tr></table></div>
    </div>
</div>

<div id="pagos" class="pantalla">
    <div class="card" style="text-align:center;">
        <h3>Generar Pin de Activaci√≥n 24hs</h3>
        <button class="btn-ok" onclick="generarNuevoCodigo()">GENERAR NUEVO C√ìDIGO</button>
        <div id="contenedorFicha" style="display: none; flex-direction: column; align-items: center; background: #fff; padding: 25px; border-radius: 15px; max-width: 300px; margin: 25px auto; color: #000; border: 3px solid #4caf50;">
            <img src="https://raw.githubusercontent.com/martinnrojas8-lgtm/smart-traslados/main/Public/IMG_20260103_204207.png" style="height: 50px;">
            <div id="txtFichaCodigo" class="ficha-codigo">000000</div>
            <div style="font-weight: bold;">V√ÅLIDO POR 24 HORAS</div>
        </div>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas de la App</h3>
        <label>Precio base por viaje</label><input type="number" id="precioBase">
        <label>Precio por km</label><input type="number" id="precioKm">
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <label>Monto suscripci√≥n 24hs (Info)</label><input type="number" id="montoFijo">
        <button class="btn-ok" onclick="guardarTarifas()">Guardar en servidor</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Mensajer√≠a Masiva</h3>
        <select id="selectDestino">
            <option value="choferes">Todos los conductores</option>
            <option value="pasajeros">Todos los pasajeros</option>
        </select>
        <input type="text" id="msgMasivo" placeholder="Escrib√≠ el mensaje">
        <button class="btn-ok" onclick="enviarMensajeMasivo()">Enviar a todos</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n de Contacto</h3>
        <label>Nombre de la app</label><input id="confApp">
        <label>Tel√©fono soporte (Ej: 5492344123456)</label><input id="confTel">
        <label>Email soporte</label><input id="confMail">
        <label>Alias / CBU para Cobros</label><input id="confAlias">
        <button class="btn-ok" onclick="guardarConfiguracion()">Guardar configuraci√≥n</button>
    </div>
</div>

<script>
let listaUsuariosGlobal = [];
let listaViajesGlobal = [];

function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
    if(id === 'viajes') cargarViajesReales();
    if(id === 'estadisticas') { 
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('inputFechaEst').value = hoy;
        actualizarEstadisticasFecha();
    }
    if(id === 'tarifas') cargarTarifas();
    if(id === 'conductores' || id === 'pasajeros' || id === 'inicio') cargarDatosReales();
}

async function cargarDatosReales() {
    try {
        const resV = await fetch('/obtener-viajes');
        listaViajesGlobal = await resV.json();
        const resU = await fetch('/obtener-usuarios');
        listaUsuariosGlobal = await resU.json();
        const conds = listaUsuariosGlobal.filter(u => (u.rol && u.rol.toLowerCase().trim() === 'chofer') || (u.autoPatente && u.autoPatente.trim() !== ""));
        const pasas = listaUsuariosGlobal.filter(u => !conds.some(c => c.telefono === u.telefono));
        document.getElementById('cActivos').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;
        actualizarTablaConductores(conds);
        actualizarTablaPasajeros(pasas);
    } catch (e) {}
}

function actualizarTablaConductores(conds) {
    let tC = document.getElementById('tablaConductores');
    tC.innerHTML = `<tr><th>Chofer (Ver Perfil)</th><th>Estado</th><th>Recaudado</th><th>Acci√≥n</th></tr>`;
    conds.forEach(c => {
        const viajesDelChofer = listaViajesGlobal.filter(v => v.choferTel === c.telefono && v.estado.toLowerCase() === "finalizado");
        const totalRecaudado = viajesDelChofer.reduce((acc, v) => acc + (parseInt(v.precio.replace(/[^0-9]/g, '')) || 0), 0);
        const pagoAlDia = c.vencimientoPago && new Date(c.vencimientoPago) > new Date();
        const docOk = c.aprobado === true;
        tC.innerHTML += `<tr>
            <td><a href="#" onclick="verPerfilCompleto('${c.telefono}')" style="color:#4caf50; text-decoration:none;"><b>${c.nombre || 'S/N'}</b></a></td>
            <td><span class="${docOk?'estado-ok':'estado-pendiente'}">${docOk?'DOC OK':'DOC PEND'}</span><br><span class="${pagoAlDia?'estado-ok':'estado-off'}">${pagoAlDia?'PAGO OK':'VENCIDO'}</span></td>
            <td>$${totalRecaudado.toLocaleString()}</td>
            <td><button class="btn-accion" style="background:#4caf50;" onclick="toggleDocumentacion('${c.telefono}', ${docOk})">‚úî</button><button class="btn-accion" style="background:#25d366;" onclick="window.open('https://wa.me/${c.telefono}')">‚úâ</button><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${c.telefono}')">üóëÔ∏è</button></td>
        </tr>`;
    });
}

function actualizarTablaPasajeros(pasas) {
    let tP = document.getElementById('tablaPasajeros');
    tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Acci√≥n</th></tr>`;
    pasas.forEach(p => { 
        tP.innerHTML += `<tr><td><b>${p.nombre || p.telefono}</b></td><td>${p.telefono}</td><td><button class="btn-accion" style="background:#f44336;" onclick="eliminarUsuario('${p.telefono}')">üóëÔ∏è</button></td></tr>`; 
    });
}

async function cargarViajesReales() {
    try {
        const res = await fetch('/obtener-viajes');
        listaViajesGlobal = await res.json();
        let tV = document.getElementById('tablaViajes');
        tV.innerHTML = `<tr><th>Fecha</th><th>Hora</th><th>Chofer</th><th>Pasajero</th><th>Calif.</th><th>Estado</th><th>Acci√≥n</th></tr>`;
        
        listaViajesGlobal.forEach(v => {
            const estadoActual = (v.estado || "pendiente").toLowerCase();
            let color = "#ff9800";
            if(estadoActual === "finalizado") color = "#4caf50";
            if(estadoActual === "cancelado") color = "#f44336";

            // BOT√ìN FINALIZAR: Aparece si NO es FINALIZADO ni CANCELADO
            let btnCheck = (estadoActual !== "finalizado" && estadoActual !== "cancelado") 
                ? `<button class="btn-accion" style="background:#2e7d32; font-size:16px;" onclick="finalizarViajeAdmin('${v._id}', '${v.precio}')">‚úÖ</button>` 
                : '';

            tV.innerHTML += `<tr>
                <td>${v.fecha}</td><td>${v.hora}</td><td>${v.chofer || '...'}</td><td>${v.pasajero || 'S/N'}</td>
                <td style="color:#ffc107;">${v.estrellasPasajero > 0 ? v.estrellasPasajero + ' ‚≠ê' : '-'}</td>
                <td style="color:${color}; font-weight:bold;">${estadoActual.toUpperCase()}</td>
                <td>${btnCheck} <button class="btn-accion" style="background:#f44336;" onclick="eliminarViajeHistorial('${v._id}')">üóëÔ∏è</button></td>
            </tr>`;
        });
    } catch (e) {}
}

async function actualizarEstadisticasFecha() {
    const fechaSel = document.getElementById('inputFechaEst').value;
    if (!fechaSel) return;
    document.getElementById('tituloDia').innerText = "Detalle del d√≠a: " + fechaSel;
    const tE = document.getElementById('tablaEstadisticasHoras');
    tE.innerHTML = `<tr><th>Franja Horaria</th><th>Viajes Solicitados</th></tr>`;
    try {
        const res = await fetch('/obtener-viajes');
        const todos = await res.json();
        const viajesDia = todos.filter(v => v.fecha === fechaSel);
        const conteo = {};
        for (let i = 0; i < 24; i++) { conteo[i.toString().padStart(2, '0') + ":00"] = 0; }
        viajesDia.forEach(v => { const hS = v.hora.split(':')[0] + ":00"; if (conteo[hS] !== undefined) conteo[hS]++; });
        Object.keys(conteo).forEach(hora => {
            tE.innerHTML += `<tr><td>${hora} hs</td><td style="font-weight:bold; color:#4caf50;">${conteo[hora]}</td></tr>`;
        });
    } catch (e) {}
}

async function finalizarViajeAdmin(id, precio) {
    const monto = prompt("Confirmar monto:", precio);
    if (monto !== null) {
        await fetch('/finalizar-viaje-admin', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ viajeId: id, monto: monto }) });
        cargarViajesReales();
    }
}

async function eliminarViajeHistorial(id) {
    if(confirm("¬øEliminar?")) {
        await fetch('/eliminar-viaje', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
        cargarViajesReales();
    }
}

async function toggleDocumentacion(tel, estado) {
    await fetch('/aprobar-chofer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel, aprobado: !estado }) });
    cargarDatosReales();
}

async function eliminarUsuario(tel) {
    if(confirm("¬øEliminar definitivamente?")) {
        await fetch('/eliminar-usuario', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefono: tel }) });
        cargarDatosReales();
    }
}

function verPerfilCompleto(tel) {
    const u = listaUsuariosGlobal.find(user => user.telefono === tel);
    if(u) {
        document.getElementById('nomPerfil').innerText = "Perfil: " + (u.nombre || 'S/N');
        const setImg = (id, src) => { const el = document.getElementById(id); if(src) { el.src = src; el.style.display="block"; } else el.style.display="none"; };
        setImg('imgCarnet', u.fotoCarnet); setImg('imgSeguro', u.fotoSeguro); setImg('imgTarjeta', u.fotoTarjeta);
        document.getElementById('modalPerfil').style.display = 'block';
    }
}

function cerrarPerfil() { document.getElementById('modalPerfil').style.display = 'none'; }

async function generarNuevoCodigo() {
    const nuevoCod = Math.floor(100000 + Math.random() * 900000).toString();
    const res = await fetch('/crear-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codigo: nuevoCod }) });
    if(res.ok) { document.getElementById('txtFichaCodigo').innerText = nuevoCod; document.getElementById('contenedorFicha').style.display = 'flex'; }
}

async function guardarTarifas() {
    const pBase = document.getElementById('precioBase').value;
    const pKm = document.getElementById('precioKm').value;
    const mF = document.getElementById('montoFijo').value;
    await fetch('/actualizar-tarifas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ precioBase: pBase, precioKm: pKm, montoFijoInfo: mF }) });
    alert('OK');
}

async function cargarTarifas() {
    const res = await fetch('/obtener-tarifas');
    const data = await res.json();
    if(data) { document.getElementById('precioBase').value = data.precioBase; document.getElementById('precioKm').value = data.precioKm; document.getElementById('montoFijo').value = data.montoFijoInfo; }
}

async function guardarConfiguracion() {
    const config = { app: document.getElementById('confApp').value, tel: document.getElementById('confTel').value, mail: document.getElementById('confMail').value, alias: document.getElementById('confAlias').value };
    await fetch('/actualizar-config-admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) });
    alert('OK');
}

window.onload = () => { cargarDatosReales(); cargarTarifas(); };
</script>
</body>
</html>
