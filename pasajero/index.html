<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Smart Traslados â€“ Pasajero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<style>
  body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; overflow-x: hidden; }
  header{ background:#111; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #00c853; }
  .screen{ padding:15px; }
  .card{ background:#111; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid #333; }
  input{ width:100%; padding:12px; margin:5px 0; border-radius:8px; border:none; background:#222; color:#fff; box-sizing:border-box; }
  button{ padding:12px; width:100%; margin-top:10px; border:none; border-radius:8px; background:#00c853; color:#000; font-weight:bold; cursor:pointer; }
  .price-box{ font-size:24px; color:#00c853; font-weight:bold; text-align:center; margin-bottom:15px; border: 1px dashed #00c853; padding: 10px; border-radius: 8px; }
  #map{ width:100%; height:350px; border-radius:10px; margin-bottom:10px; background: #222; }
  .btn-perfil{ width:40px; height:40px; border-radius:50%; border:2px solid #00c853; overflow:hidden; background:#333; display:flex; align-items:center; justify-content:center; }
  .btn-perfil img{ width:100%; height:100%; object-fit:cover; }
  #modalConfirmacion { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; }
  #panelSeguimiento { display: none; background: #111; border-top: 2px solid #00c853; padding: 20px; position: fixed; bottom: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 100; border-radius: 20px 20px 0 0; }
</style>
</head>
<body>

<header>
  <div style="width:40px"></div> <h2 style="margin:0; font-size:18px;">Smart Traslados</h2>
  <div class="btn-perfil" onclick="location.href='perfil.html'">
      <img id="fotoHeader" src="" style="display:none;">
      <span id="iconoUser">ðŸ‘¤</span>
  </div>
</header>

<div id="modalConfirmacion">
    <div style="background: #111; border: 2px solid #00c853; padding: 30px; border-radius: 20px; width: 90%;">
        <h2 style="color:#00c853;">Â¡CHOFER EN CAMINO!</h2>
        <div style="font-size: 50px; margin: 10px 0;">ðŸš•</div>
        <p id="infoChoferM" style="font-size: 18px; font-weight: bold;"></p>
        <p id="infoAutoM" style="color: #aaa; margin-bottom: 20px;"></p>
        <button onclick="iniciarModoSeguimiento()">VER EN EL MAPA</button>
    </div>
</div>

<div class="screen">
  <div id="map"></div>

  <div class="card" id="cardPedido">
    <input type="text" id="origen" placeholder="Cargando ubicaciÃ³n...">
    <input type="text" id="destino" placeholder="Â¿A dÃ³nde vas?">
    <div id="infoDistancia" style="text-align:center; color:#aaa; margin-top:10px;">Distancia: 0 km</div>
    <div class="price-box" id="cuadroPrecio">Total: $0</div>
    <button id="btnPedir" onclick="pedirViaje()">SOLICITAR AHORA</button>
  </div>

  <div id="estadoEspera" style="display:none; text-align: center;">
      <div class="price-box">BUSCANDO CHOFER...</div>
      <div style="width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #00c853; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;"></div>
  </div>
</div>

<div id="panelSeguimiento">
    <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 30px;">ðŸš•</div>
        <div style="flex-grow: 1;">
            <div id="txtC" style="font-weight: bold; color: #00c853;"></div>
            <div id="txtA" style="font-size: 14px; color: #ccc;"></div>
        </div>
        <button id="btnLlamar" style="width:auto; padding:8px 12px; background:#222; color:#fff; border:1px solid #444;">ðŸ“ž</button>
    </div>
    <button onclick="location.reload()" style="background:#ff5252; color:#fff; margin-top:10px; font-size:12px;">FINALIZAR</button>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB8zZaje1NKai0k2MxuQvQVW6vrRdfUIrY&libraries=places"></script>
<script>
const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");
let map, directionsService, directionsRenderer, markerC, idViaje, viajeInfo;

async function initApp() {
    if (!sesion.telefono) return location.href = "/";
    if(sesion.foto) { document.getElementById("fotoHeader").src = sesion.foto; document.getElementById("fotoHeader").style.display = "block"; }
    
    map = new google.maps.Map(document.getElementById("map"), { center: {lat:-35.638, lng:-59.779}, zoom: 15, disableDefaultUI: true });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });

    const autoO = new google.maps.places.Autocomplete(document.getElementById("origen"), { componentRestrictions:{country:"ar"} });
    const autoD = new google.maps.places.Autocomplete(document.getElementById("destino"), { componentRestrictions:{country:"ar"} });
    
    autoO.addListener("place_changed", calcularRuta); 
    autoD.addListener("place_changed", calcularRuta);

    if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => {
        const pos = { lat: p.coords.latitude, lng: p.coords.longitude }; 
        map.setCenter(pos);
        new google.maps.Geocoder().geocode({location:pos}, r => { 
            if(r[0]) document.getElementById("origen").value=r[0].formatted_address; 
            calcularRuta(); 
        });
    });
}

function calcularRuta() {
    const o = document.getElementById("origen").value, d = document.getElementById("destino").value;
    if(!o || !d) return;
    directionsService.route({ origin:o, destination:d, travelMode:'DRIVING' }, (res, stat) => {
        if(stat === 'OK') {
            directionsRenderer.setDirections(res);
            let dist = res.routes[0].legs[0].distance.value / 1000;
            let precio = dist <= 4 ? 3500 : dist * 900;
            document.getElementById("infoDistancia").innerText = "Distancia: " + dist.toFixed(1) + " km";
            document.getElementById("cuadroPrecio").innerText = "Total: $" + Math.round(precio);
        }
    });
}

function pedirViaje() {
    const pedido = { 
        pasajeroTel: sesion.telefono, 
        pasajeroNombre: sesion.nombre, 
        origen: document.getElementById("origen").value, 
        destino: document.getElementById("destino").value, 
        precio: document.getElementById("cuadroPrecio").innerText 
    };
    fetch("/solicitar-viaje", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(pedido) })
    .then(r => r.json()).then(data => {
        idViaje = data.id; 
        document.getElementById("cardPedido").style.display="none"; 
        document.getElementById("estadoEspera").style.display="block";
        
        const mon = setInterval(async () => {
            const resV = await fetch('/obtener-viajes'); 
            const viajes = await resV.json();
            const miV = viajes.find(v => v._id === idViaje);
            if(miV && miV.estado === "aceptado") { 
                clearInterval(mon); 
                viajeInfo = miV; 
                document.getElementById("infoChoferM").innerText = miV.chofer; 
                document.getElementById("infoAutoM").innerText = `${miV.autoModelo} - ${miV.autoPatente}`; 
                document.getElementById("modalConfirmacion").style.display="flex"; 
            }
        }, 3000);
    });
}

function iniciarModoSeguimiento() {
    document.getElementById("modalConfirmacion").style.display="none"; 
    document.getElementById("estadoEspera").style.display="none"; 
    document.getElementById("panelSeguimiento").style.display="block";
    
    document.getElementById("txtC").innerText = viajeInfo.chofer; 
    document.getElementById("txtA").innerText = `${viajeInfo.autoModelo} (${viajeInfo.autoColor}) â€¢ ${viajeInfo.autoPatente}`;
    document.getElementById("btnLlamar").onclick = () => window.open(`tel:${viajeInfo.choferTel}`);

    // Limpiamos la ruta previa para ver solo el auto
    directionsRenderer.setDirections({routes: []});

    setInterval(async () => {
        try {
            const r = await fetch("/obtener-choferes-activos"); 
            const choferes = await r.json();
            const c = choferes.find(x => x.telefono === viajeInfo.choferTel);
            if(c) {
                const p = { lat: Number(c.lat), lng: Number(c.lng) };
                if(!markerC) {
                    markerC = new google.maps.Marker({ 
                        position: p, 
                        map: map, 
                        icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale:8, fillColor:"#00c853", fillOpacity:1, strokeColor:"#fff", strokeWeight:2} 
                    });
                } else {
                    markerC.setPosition(p);
                }
                map.panTo(p);
                if (map.getZoom() < 16) map.setZoom(16);
            }
        } catch(e) { console.log("Error GPS", e); }
    }, 5000);
}

window.onload = initApp;
</script>
</body>
</html>
